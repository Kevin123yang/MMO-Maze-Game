<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Game â€“ MMO Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary-color: #3a10e5;
      --secondary-color: #ff5722;
      --dark-color: #1e1e2f;
      --light-color: #f5f5f5;
      --ui-dark: rgba(20, 20, 35, 0.85);
      --ui-border: rgba(58, 16, 229, 0.5);
      --error-color: #e74c3c;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: #000;
      color: var(--light-color);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Overall page container */
    .game-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* Header section styling */
    .game-header {
      background: var(--ui-dark);
      border-bottom: 2px solid var(--ui-border);
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: 'Orbitron', sans-serif;
    }

    /* Header button group layout */
    .header-buttons {
      display: flex;
      gap: 10px;
    }

    /* Button base styling */
    .btn {
      display: inline-block;
      padding: 8px 20px;
      border: 2px solid;
      border-radius: 50px;
      text-decoration: none;
      font-family: 'Orbitron', sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
      transition: all 0.3s ease;
      color: var(--light-color);
    }

    /* Home button (white border) */
    .btn-home {
      border-color: var(--light-color);
    }
    .btn-home:hover {
      background: var(--light-color);
      color: var(--dark-color);
    }

    /* Logout button (red border) */
    .btn-danger {
      border-color: var(--error-color);
    }
    .btn-danger:hover {
      background: var(--error-color);
      color: var(--light-color);
    }

    /* User information layout */
    .user-info {
      display: flex;
      align-items: center;
    }
    .user-avatar {
      width: 36px;
      height: 36px;
      background: var(--primary-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 10px;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    .user-name { color: var(--secondary-color); font-weight: bold; }

    /* Main game content area: fills remaining space */
    .game-content {
      flex: 1;
      background: var(--ui-dark);
      position: relative;
      display: flex;
      justify-content: stretch;
      align-items: stretch;
      overflow: hidden;
    }

    /* Starfield background layer */
    #stars-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
    }

    /* Game canvas: occupies full width and height */
    #game-canvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      width: 90% !important;
      height: 90% !important;
      max-width: none;
      aspect-ratio: auto;
    }

    /* Welcome message styling and animation */
    .game-message {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--ui-dark);
      padding: 15px 30px;
      border-radius: 50px;
      border: 1px solid var(--ui-border);
      font-family: 'Orbitron', sans-serif;
      text-transform: uppercase;
      letter-spacing: 1px;
      animation: fadeInOut 5s forwards;
      z-index: 2;
    }
    @keyframes fadeInOut {
      0%   { opacity: 0; transform: translate(-50%, -20px); }
      10%  { opacity: 1; transform: translate(-50%, 0); }
      80%  { opacity: 1; transform: translate(-50%, 0); }
      100% { opacity: 0; transform: translate(-50%, -20px); }
    }

    /* Control instructions panel */
    .key-controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: var(--ui-dark);
      border: 1px solid var(--ui-border);
      border-radius: 10px;
      padding: 15px;
      font-family: 'Orbitron', sans-serif;
      z-index: 2;
    }
    .key-controls h3 {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.7);
      text-transform: uppercase;
      margin-bottom: 10px;
      text-align: center;
    }
    .key-item { display: flex; align-items: center; margin-bottom: 5px; }
    .key { display: inline-block; min-width: 30px; text-align: center;
      background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px; padding: 2px 8px; margin-right: 8px; font-size: 0.8rem;
    }
    .key-action { font-size: 0.8rem; color: var(--light-color); }
  </style>
</head>

<body>
  <div class="game-container">
    <div class="game-header">
      <div class="user-info">
        <div class="user-avatar">{{ current_user.username[0].upper() }}</div>
        <div class="user-name">{{ current_user.username }}</div>
      </div>
      <div class="header-buttons">
        <a href="{{ url_for('index') }}" class="btn btn-home">Home</a>
        <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
      </div>
    </div>

    <div class="game-content">
      <canvas id="stars-canvas"></canvas>
      <canvas id="game-canvas"></canvas>
      <div class="game-message">
        Welcome, {{ current_user.username }}! Move with WASD keys.
      </div>

      <div class="key-controls">
        <h3>Controls</h3>
        <div class="key-item"><span class="key">W</span><span class="key-action">Up</span></div>
        <div class="key-item"><span class="key">A</span><span class="key-action">Left</span></div>
        <div class="key-item"><span class="key">S</span><span class="key-action">Down</span></div>
        <div class="key-item"><span class="key">D</span><span class="key-action">Right</span></div>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='mazeList_compact.js') }}"></script>
  <script>
    // Starfield background rendering
    const starsCanvas = document.getElementById('stars-canvas');
    const starsCtx    = starsCanvas.getContext('2d');
    function resizeStars() {
      starsCanvas.width  = starsCanvas.clientWidth;
      starsCanvas.height = starsCanvas.clientHeight;
    }
    window.addEventListener('resize', resizeStars);
    resizeStars();

    const stars = Array.from({ length: 100 }, () => ({
      x: Math.random() * starsCanvas.width,
      y: Math.random() * starsCanvas.height,
      r: Math.random() * 2 + 0.5,
      o: Math.random() * 0.8 + 0.2
    }));

    function drawStars() {
      starsCtx.clearRect(0, 0, starsCanvas.width, starsCanvas.height);
      stars.forEach(s => {
        starsCtx.beginPath();
        starsCtx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
        starsCtx.fillStyle = `rgba(255,255,255,${s.o})`;
        starsCtx.fill();
      });
      requestAnimationFrame(drawStars);
    }
    drawStars();

    // Main game logic
    const canvas     = document.getElementById('game-canvas');
    const ctx        = canvas.getContext('2d');
    const canvasSize = 1200;
    canvas.width     = canvasSize;
    canvas.height    = canvasSize;

    let maze       = mazeList_compact[Math.floor(Math.random() * mazeList_compact.length)];
    const numRows  = maze.length;
    const numCols  = maze[0].length;
    const cellSize = canvasSize / numRows;

    // Player initialization
    const player = {
      row: 1,
      col: 1,
      color: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
      trail: [],
      username: "{{ current_user.username }}"
    };
    const startRow = 1, startCol = 1;
    const goalRow  = numRows - 2, goalCol = numCols - 2;

    const keys = {};
    window.addEventListener('keydown', e => keys[e.key] = true);
    window.addEventListener('keyup',   e => keys[e.key] = false);
    let lastMove = 0, moveDelay = 150;

    // Attempt player movement
    function tryMove(dr, dc) {
      const r = player.row + dr, c = player.col + dc;
      if (r >= 0 && r < numRows && c >= 0 && c < numCols && maze[r][c] === 0) {
        player.row = r;
        player.col = c;
        player.trail.push({ x: c * cellSize + cellSize / 2, y: r * cellSize + cellSize / 2 });
        if (player.trail.length > 10) player.trail.shift();
      }
    }

    // Reset game state
    function reset() {
      maze = mazeList_compact[Math.floor(Math.random() * mazeList_compact.length)];
      player.row = startRow;
      player.col = startCol;
      player.trail = [];
      Object.keys(keys).forEach(k => keys[k] = false);
      lastMove = Date.now();
    }

    // Update player based on input timing
    function updatePlayer() {
      const now = Date.now();
      if (now - lastMove < moveDelay) return;
      if (keys['w'] || keys['ArrowUp'])    { tryMove(-1, 0); lastMove = now; }
      if (keys['s'] || keys['ArrowDown'])  { tryMove( 1, 0); lastMove = now; }
      if (keys['a'] || keys['ArrowLeft'])  { tryMove( 0,-1); lastMove = now; }
      if (keys['d'] || keys['ArrowRight']) { tryMove( 0, 1); lastMove = now; }
      if (player.row === goalRow && player.col === goalCol) {
        setTimeout(() => { alert("ðŸŽ‰ You win!"); reset(); }, 100);
      }
    }

    // Draw the maze grid
    function drawMaze() {
      for (let r = 0; r < numRows; r++) {
        for (let c = 0; c < numCols; c++) {
          if (maze[r][c] === 1) {
            ctx.fillStyle = '#222';
            ctx.fillRect(c * cellSize, r * cellSize, cellSize, cellSize);
          }
        }
      }
      ctx.fillStyle = 'rgba(0,255,0,0.3)';
      ctx.fillRect(goalCol * cellSize, goalRow * cellSize, cellSize, cellSize);
    }

    // Draw the player avatar and name
    function drawPlayer() {
      const x = player.col * cellSize + cellSize / 2;
      const y = player.row * cellSize + cellSize / 2;
      ctx.fillStyle = player.color;
      ctx.beginPath();
      ctx.arc(x, y, cellSize * 0.35, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = '#fff';
      ctx.font = '14px Orbitron';
      ctx.textAlign = 'center';
      ctx.fillText(player.username, x, y - cellSize * 0.6);
    }

    // Main game loop
    function loop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawMaze();
      updatePlayer();
      drawPlayer();
      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>
</html>
